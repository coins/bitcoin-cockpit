<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Derive Addresses</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" type="text/css" href="static/bitcoin.css">
    <style>
        textarea{
            height: 160px;
        }
        input{
            width: 100px;
        }
        .row > .item{
            margin-right: 24px;
        }
    </style>
</head>

<body>
    <header>
<img src="static/bitcoin_logo.svg" width="120">
    </header>
    <main>
        <h1>Derive Addresses</h1>
        <x-subtitle>Derives one or more addresses corresponding to an output descriptor.</x-subtitle>
        <div class="item" label="Descriptor:">
            <textarea id="$descriptor">sh(sortedmulti(3,xpub6BG19sAxMMdQP1mcXaDYqkDdoeUQtzw7DHjr9M1rh3vJpcFJJbNUidMsuMbfvMbJ1H9K7boBvaMy1Q1jHa9UXTmzxg3KDto7h6pZpYTrM6Q/0/*,xpub6ATyc4yRJ1vo1JT4Ro5asfBEpEVfFGBFMuHvJhBsbbvGe9pctVarxsPJpeAnsV1zZpzrZ8NFTby9ihMysjsHkHTnDLr9sY6x8k3PuRZF524/0/*,xpub6AAQ7FoVcjpeP8iRFDWRySaEGdLyCA7wHKVGXknKawVkL5dVA3kgrjRfeA1a7DsfSk7MqGEYvv7cCMaK73hCUzfe2tDuc8aNGmXeiSVq43R/0/*,xprv9s21ZrQH143K2bpgrXNezh2wQLmbLXZqvxX21GdCpyJZjvpgy1Y1EMaXCuALw9GWgBi4JVftSdEZTTdEPnAUnTzyCPy88TxF5dvJHsLy14x/0'/0'/0/*,xpub6APdkAEeCs4tv52hCr1tvGTmsN1V3dXpFnBoyaYkrmJ78rosCUuv1pAUoQWPy7R9MubfsaKUQk6x6xvghRXDw4DP4mwNcMs7UVSrDGPmyST/0/*))</textarea>
        </div>
        <div class="row">
            <div class="item" label="Start Index">
                <input id="$startIndex" value="0" type="number" min="0">
            </div>
            <div class="item" label="End Index">
                <input id="$endIndex" value="10" type="number" min="0">
            </div>
        </div>
        <div class="row-reverse">
            <button id="$submit">Derive Addresses</button>
        </div>
        <div class="error" id="$error"></div>
        <h2>Derived Addresses</h2>
        <div id="$addresses"></div>
    </main>
</body>
<script src="static/bitcoin-rpc.js"></script>
<script>
async function deriveAddresses() {
    // Reset UI
    $addresses.innerHTML = ''
    $error.textContent = ''

    // Input Values
    const descriptor = $descriptor.value.trim()
    const startIndex = Number($startIndex.value)
    const endIndex = Number($endIndex.value)

    const isRange = descriptor.indexOf('*') > -1

    let info;

    try {
        info = await bitcoinRPC('getdescriptorinfo', [descriptor])
    } catch (e) {
        $error.textContent = e
        return
    }

    let checkedDescriptor;
    if (descriptor.indexOf('#') === -1)
        checkedDescriptor = descriptor + '#' + info.checksum
    else
        checkedDescriptor = descriptor

    let addresses;

    try {
        if (isRange)
            addresses = await bitcoinRPC('deriveaddresses', 
                [checkedDescriptor, [startIndex, endIndex]])
        else
            addresses = await bitcoinRPC('deriveaddresses', [checkedDescriptor])
    } catch (e) {
        $error.textContent = e
        return
    }

    addresses.forEach((address, index) => {
        const item = document.createElement('div')
        item.className = 'item'
        const label = isRange ? (index + startIndex) : ''
        item.setAttribute('label', 'Address ' + label)
        item.textContent = address
        $addresses.append(item)
    })
}

$submit.addEventListener('click', e => deriveAddresses())
</script>

</html>